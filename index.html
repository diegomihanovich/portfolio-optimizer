<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Optimizador de Portafolio Pro</title>

  <!-- Tus fuentes + estilos originales ------------------------------->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
        :root {
            --primary-color: #007BFF; /* Azul primario vibrante */
            --secondary-color: #6C757D; /* Gris secundario */
            --success-color: #28A745; /* Verde éxito */
            --danger-color: #DC3545; /* Rojo peligro */
            --warning-color: #FFC107; /* Amarillo advertencia */
            --info-color: #17A2B8; /* Turquesa info */
            --light-bg: #F8F9FA; /* Fondo muy claro */
            --dark-text: #212529; /* Texto oscuro principal */
            --medium-text: #495057; /* Texto medio */
            --light-text: #6C757D; /* Texto claro */
            --border-color: #DEE2E6; /* Color de borde sutil */
            --card-bg: #FFFFFF; /* Fondo de tarjetas */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.07);
            --border-radius: 6px; /* Radio de borde uniforme */
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--dark-text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.6;
        }
        header {
            background-color: var(--dark-text);
            color: var(--light-bg);
            padding: 25px 20px;
            text-align: center;
            box-shadow: var(--shadow-md);
        }
        header h1 {
            margin: 0;
            font-size: 2.2em;
            font-weight: 300;
        }
        .container {
            display: flex;
            flex: 1;
            padding: 25px;
            gap: 30px;
        }
        .sidebar {
            width: 380px; /* Un poco más ancho para la nueva info */
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex: 1;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
        }
        .control-group {
            margin-bottom: 25px;
        }
        .control-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--medium-text);
            font-size: 0.95em;
        }
        .control-group input[type="text"],
        .control-group input[type="number"],
        .control-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .control-group input[type="text"]:focus,
        .control-group input[type="number"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
            outline: none;
        }
        .selected-assets-list {
            list-style: none;
            padding: 0;
            max-height: 200px; /* Aumentado un poco */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-top: 10px;
        }
        .selected-assets-list li {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .selected-assets-list li:last-child {
            border-bottom: none;
        }
        .selected-assets-list .asset-info {
            display: flex;
            flex-direction: column;
        }
        .selected-assets-list .asset-name-list {
            font-weight: 500;
        }
        .selected-assets-list .asset-volatility-list {
            font-size: 0.85em;
            color: var(--light-text);
        }
        .selected-assets-list button {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s ease;
            margin-left: 10px; /* Espacio para el botón */
        }
        .selected-assets-list button:hover {
            background-color: #c82333;
        }
        .chart-placeholder {
            width: 100%;
            height: 400px;
            background-color: #e9ecef;
            border:1px solid #adb5bd; 
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--light-text);
            font-size: 1.2em;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }
        .section-title {
            font-size: 1.5em;
            font-weight: 500;
            color: var(--dark-text);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .portfolio-details h4 {
            font-size: 1.1em;
            color: var(--medium-text);
            margin-top: 25px;
            margin-bottom: 15px;
        }
        .weights-list {
            list-style: none;
            padding: 0;
        }
        .weights-list li {
            background-color: var(--light-bg);
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            display: grid; /* Cambiado a grid para mejor alineación de múltiples datos */
            grid-template-columns: auto 1fr auto auto; /* Nombre, Volatilidad, Peso, Monto */
            gap: 15px; /* Espacio entre columnas */
            align-items: center;
            border: 1px solid #e9ecef;
        }
        .weights-list .asset-name {
            font-weight: 500;
            color: var(--dark-text);
        }
        .weights-list .asset-individual-volatility {
            font-size: 0.85em;
            color: var(--warning-color); /* Amarillo/Naranja para destacar el riesgo */
            font-style: italic;
            justify-self: start; /* Alinea a la izquierda dentro de su celda */
        }
        .weights-list .asset-weight {
            color: var(--success-color);
            font-weight: 700;
            font-size: 1.05em;
            justify-self: end; /* Alinea a la derecha */
        }
        .weights-list .asset-amount {
            color: var(--primary-color);
            font-weight: 500;
            justify-self: end; /* Alinea a la derecha */
            min-width: 100px; /* Para asegurar espacio */
            text-align: right;
        }
        .risk-return-display {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #e7f3fe;
            border-left: 5px solid var(--primary-color);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        .risk-return-display p {
            margin: 8px 0;
            font-size: 1.1em;
        }
        .risk-return-display strong {
            color: var(--primary-color);
        }
        .button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 500;
            text-align: center;
            display: inline-block;
            margin-top: 10px;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        }
        .button:hover {
            background-color: #0069d9;
            box-shadow: 0 4px 8px rgba(0,123,255,0.2);
            transform: translateY(-2px);
        }
        .button:active {
            transform: translateY(0px);
            box-shadow: var(--shadow-sm);
        }
        .button.secondary {
            background-color: var(--secondary-color);
        }
        .button.secondary:hover {
            background-color: #5a6268;
            box-shadow: 0 4px 8px rgba(108,117,125,0.2);
        }
        .button.success {
            background-color: var(--success-color);
        }
        .button.success:hover {
            background-color: #218838;
            box-shadow: 0 4px 8px rgba(40,167,69,0.2);
        }
        footer {
            text-align: center;
            padding: 25px;
            background-color: var(--dark-text);
            color: #adb5bd;
            font-size: 0.9em;
            margin-top: auto;
        }
        .slider-container {
            margin-bottom: 25px;
        }
        input[type="range"] {
            width: 100%;
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            color: var(--light-text);
            margin-top: 8px;
        }
        .info-icon {
            cursor: help;
            margin-left: 8px;
            color: var(--info-color); /* Usando el color info */
            border: 1px solid var(--border-color);
            background-color: var(--light-bg);
            border-radius: 50%;
            padding: 3px 8px;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            line-height: 1;
            transition: all 0.2s ease;
            text-decoration: none; /* Para que no parezca un link */
        }
        .info-icon:hover {
            background-color: var(--info-color);
            color: white;
            border-color: var(--info-color);
        }
        .advice-section {
            margin-top: 25px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }
        .advice-section summary {
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 1.05em;
            list-style-type: '► '; /* Un pequeño indicador, se puede mejorar con SVG */
        }
        .advice-section details[open] summary {
            list-style-type: '▼ ';
        }
        .advice-section details p {
            font-size: 0.9em;
            color: var(--medium-text);
            padding-left: 20px;
            border-left: 3px solid var(--primary-color);
            margin-bottom: 12px;
            background-color: #fbfdff;
            padding-top: 8px;
            padding-bottom: 8px;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
</style>

  <!-- Librerías externas (CDN) --------------------------------------->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <!-- ============  TU PLANTILLA ORIGINAL  ============ -->
  <!-- (solo se añadieron id que faltaban y se quitó el botón duplicado) -->

  <header><h1>Optimizador de Portafolio Pro</h1></header>

  <div class="container">
    <aside class="sidebar">
      <div class="control-group">
        <label for="asset-search">Buscar y Seleccionar Activos</label>
        <!-- ① input que usará el script -->
        <input type="text" id="asset-search" placeholder="Ticker o Nombre: Ej: AAPL, MSFT…">
        <!-- ② botón añadir -->
        <button id="addAssetBtn" class="button secondary" style="margin-top:10px; width:100%;">Añadir Activo</button>
      </div>
<!-- Frecuencia de datos -->
<div class="control-group">
  <label for="freq-select">Frecuencia de datos:</label>
  <select id="freq-select">
    <option value="d" selected>Diaria</option>
    <option value="w">Semanal</option>
    <option value="m">Mensual</option>
  </select>
</div>
      <!-- ③ lista dinámica -->
      <div class="control-group">
        <label>Activos Seleccionados:</label>
        <ul class="selected-assets-list" id="assetList"></ul>
        <p id="assetCounter" class="text-sm" style="margin:4px 0;"></p>
      </div>

      <!-- ▌ NUEVO : monto a invertir + selector de riesgo ---------------->
<div class="control-group">
  <label for="investment-amount">Monto a Invertir (USD):</label>
  <input type="number" id="investment-amount" value="10000"
         min="0" step="100">
</div>

<div class="slider-container control-group">
  <label for="risk-tolerance">
        Preferencia Riesgo / Retorno
  </label>
  <input type="range" id="risk-tolerance" min="0" max="100" value="50">
  <div class="slider-labels">
    <span>Conservador</span><span>Agresivo</span>
  </div>
</div>
<!-- ▌ fin bloque nuevo ---------------------------------------------->


      <!-- ④ botón principal -->
      <button id="optimizeBtn" class="button success" style="width:100%;">Optimizar Portafolio</button>
    </aside>

    <main class="main-content">
      <h2 class="section-title">Frontera Eficiente &amp; Composición</h2>

      <!-- ⑤ aquí cae el gráfico -->
      <div class="chart-placeholder" id="efficient-frontier-chart">
        Gráfico en preparación…
      </div>

      <div class="portfolio-details">
        <h3 class="section-title">Portafolio Máx Sharpe</h3>
        <div class="risk-return-display">
          <p><strong>Retorno&nbsp;μ (anual):</strong> <span id="portfolio-return">–</span></p>
          <p><strong>Riesgo&nbsp;σ (anual):</strong> <span id="portfolio-risk">–</span></p>
        </div>
        <h4 id="total-investment-display">Distribución óptima de activos:</h4>
        <ul class="weights-list" id="portfolio-weights"></ul>
      </div>
    </main>
  </div>

  <footer>© 2025 Optimizador de Portafolio Pro – solo fines educativos</footer>

  <!-- ===================  SCRIPT  ==================== -->
  <script>
  /******** Config & utilidades ****************************************/
  const MAX_ASSETS = 20;                 // límite
  const listUl     = document.getElementById('assetList');
  const counterP   = document.getElementById('assetCounter');
  const addBtn     = document.getElementById('addAssetBtn');
  const inp        = document.getElementById('asset-search');
  const optimizeBtn= document.getElementById('optimizeBtn');
    const amountInput = document.getElementById('investment-amount');
const riskRange   = document.getElementById('risk-tolerance');  // (lo usaremos pronto)
  let assets = [];                       // tickers en mayúsculas

  function refreshUI () {
    listUl.innerHTML='';
    assets.forEach(t=>{
      const li = document.createElement('li');
      li.innerHTML = `<span>${t}</span><button data-tkr="${t}">✕</button>`;
      listUl.appendChild(li);
    });
    counterP.textContent = `${assets.length} / ${MAX_ASSETS} activos`;
    addBtn.disabled      = assets.length>=MAX_ASSETS;
    optimizeBtn.disabled = assets.length<2;
  }
  function addAsset (){
    const t = inp.value.trim().toUpperCase();
    inp.value='';
    if(!t||assets.includes(t)||assets.length>=MAX_ASSETS) return;
    assets.push(t); refreshUI();
  }
  listUl.addEventListener('click',e=>{
    if(e.target.dataset.tkr){
      assets = assets.filter(x=>x!==e.target.dataset.tkr);
      refreshUI();
    }
  });
  addBtn.addEventListener('click',addAsset);
  inp.addEventListener('keydown',e=>{if(e.key==='Enter') addAsset();});
  refreshUI();

  /******** Fetch histórico desde Stooq *******************************/
  async function fetchHistory(tkr){
  const freq = document.getElementById('freq-select').value;   //  ← NUEVO
  const url  = 'https://corsproxy.io/?' +
               encodeURIComponent(`https://stooq.com/q/d/l/?s=${tkr}.US&i=${freq}`);
  const csv  = await fetch(url).then(r=>r.text());
    const {data}=Papa.parse(csv,{header:true,dynamicTyping:true});
    return data.filter(r=>r.Close);
  }
  function toReturns(arr){
    const r=[];for(let i=1;i<arr.length;i++){
      const p0=arr[i-1].Close,p1=arr[i].Close;
      if(p0&&p1) r.push(Math.log(p1/p0));
    }return r;
  }
  const mean  = a=>a.reduce((s,v)=>s+v,0)/a.length;
  const cov   =(x,y,mx,my)=>x.reduce((s,v,i)=>s+(v-mx)*(y[i]-my),0)/(x.length-1);
  const randW = n=>{const w=Array.from({length:n},Math.random);
                    const s=w.reduce((a,b)=>a+b,0);return w.map(v=>v/s);};
  const pMean =(w,mu)=>w.reduce((s,wi,i)=>s+wi*mu[i],0);
  const pVar  =(w,S)=>w.reduce((s,wi,i)=>s+wi*
                    w.reduce((ss,wj,j)=>ss+wj*S[i][j],0),0);
<div class="control-group">
  <label for="rf-input">Tasa libre de riesgo&nbsp;(anual&nbsp;%):</label>
  <input type="number" id="rf-input" value="2" min="0" step="0.25">
</div>
  /******** Botón Optimizar *******************************************/
optimizeBtn.addEventListener('click', async () => {
  optimizeBtn.disabled = true;

  try {
    /* ---------- 1. Descarga paralela ---------- */
    const sets = await Promise.all(assets.map(t => fetchHistory(t)));

    /* ---------- 2. Alinear longitudes ---------- */
    const rets  = sets.map(toReturns);
    const minL  = Math.min(...rets.map(r => r.length));
    const aligned = rets.map(r => r.slice(-minL));

    /* ---------- 3. µ y Σ anualizados ---------- */
    const mu = aligned.map(mean).map(m => m * 252);
    const Σ  = aligned.map((r, i) => aligned.map((c, j) =>
                 cov(r, c, mu[i] / 252, mu[j] / 252) * 252));

    /* ---------- 4. Monte-Carlo ---------- */
    const sims = [];
    for (let k = 0; k < 5000; k++) {
      const w  = randW(mu.length);
      const r  = pMean(w, mu);
      const sd = Math.sqrt(pVar(w, Σ));
      const rf = parseFloat(document.getElementById('rf-input').value)/100;  // NUEVO
      sims.push({ w, r, sd, sh: r / sd });
    }
    const minV = sims.reduce((a, b) => (a.sd < b.sd ? a : b));
    const maxS = sims.reduce((a, b) => (a.sh > b.sh ? a : b));
    const alpha = riskRange.value / 100;                   // 0-1
const wStar = minV.w.map((w,i)=> w*(1-alpha) + maxS.w[i]*alpha);
const rStar = pMean(wStar, mu);
const sdStar= Math.sqrt(pVar(wStar, Σ));

    /* ---------- 5. Gráfico ---------- */
    document.getElementById('efficient-frontier-chart').innerHTML = '';
    Plotly.newPlot('efficient-frontier-chart', [
      {
        x: sims.map(p => p.sd * 100),
        y: sims.map(p => p.r * 100),
        mode: 'markers',
        marker: { size: 4, opacity: 0.4 },
        name: 'Portafolios'
      },
      {
        x: [minV.sd * 100],
        y: [minV.r * 100],
        mode: 'markers+text',
        text: ['Min Var'],
        marker: { color: 'green', size: 10 }
      },
      {
        x: [maxS.sd * 100],
        y: [maxS.r * 100],
        mode: 'markers+text',
        text: ['Máx Sharpe'],
        marker: { color: 'red', size: 10 }
      }
    ], {
      title: 'Frontera eficiente (anualizada)',
      xaxis: { title: 'Riesgo σ (%)' },
      yaxis: { title: 'Retorno μ (%)' }
      {
  x:[sdStar*100], y:[rStar*100],
  mode:'markers+text',
  text:['Tu elección'],
  marker:{color:'gold', size:12, symbol:'star'}
},
    });

    /* ---------- 6. Mostrar métricas ---------- */
    document.getElementById('portfolio-return').textContent =
    (rStar*100).toFixed(2)+' %';
document.getElementById('portfolio-risk').textContent  =
    (sdStar*100).toFixed(2)+' %';
    
    /* ---------- 7. Lista de pesos + montos ---------- */
    const total = parseFloat(document.getElementById('investment-amount').value) || 0;
    const title = `Distribución óptima de activos (${total.toLocaleString('en-US', {
                     style: 'currency', currency: 'USD', minimumFractionDigits: 0
                   })} invertidos):`;
    document.getElementById('total-investment-display').textContent = title;

    const ul = document.getElementById('portfolio-weights');
    ul.innerHTML = '';
    maxS.w.forEach((w, i) => {
      const usd = w * total;
      const li  = document.createElement('li');
      li.innerHTML = `
        <span class="asset-name">${assets[i]}</span>
        <span></span>
        <span class="asset-weight">${(w * 100).toFixed(2)} %</span>
        <span class="asset-amount">${usd.toLocaleString('en-US', {
              style: 'currency', currency: 'USD', minimumFractionDigits: 0
        })}</span>`;
      ul.appendChild(li);
    });

    console.log('μ:', mu, 'Σ:', Σ, 'Max Sharpe:', maxS);
  } catch (err) {
    alert(err.message);
    console.error(err);
  } finally {
    optimizeBtn.disabled = false;
  }
});
  </script>
</body>
</html>
