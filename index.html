<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Optimizer â€“ Fase 3 Â· Paso 1</title>

  <!-- CDNs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11.11.2/lib/browser/math.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-6">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-semibold mb-6 text-center">
      Portfolio Optimizer â€“ Fase 3 Â· Paso 1
    </h1>

    <!-- === Bloque Seleccionar activos === -->
    <div class="space-y-4 mb-10">
      <!-- Campo + botÃ³n AÃ±adir -->
      <div class="flex gap-2">
        <input id="assetInput" type="text" placeholder="Ticker (ej: AAPL)"
               class="flex-1 border rounded px-3 py-2" />
        <button id="addAssetBtn"
                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          AÃ±adir
        </button>
      </div>

      <!-- Lista dinÃ¡mica -->
      <ul id="assetList" class="space-y-2"></ul>

      <!-- Contador / aviso -->
      <p id="assetCounter" class="text-sm text-gray-600"></p>

      <!-- BotÃ³n continuar (descarga en el Paso 2) -->
      <button id="nextBtn"
              class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700"
              disabled>
        Continuar con descarga â–¼
      </button>
      <p id="statusMsg" class="text-sm text-blue-600 mt-2"></p>
    </div>

    <!-- Contenedor del grÃ¡fico (lo usaremos mÃ¡s adelante) -->
    <div id="chart" class="bg-white p-4 rounded shadow-md" style="height:400px;"></div>
  </div>

  <!-- =========  SCRIPTS  ========= -->
  <script>
  console.log("ðŸ”§ Script F3-P1 cargado");

  /* ---------- GestiÃ³n de lista ---------- */
  const MAX_ASSETS = 20;
  let assets = [];                               // tickers en mayÃºsculas

  const inp      = document.getElementById('assetInput');
  const addBtn   = document.getElementById('addAssetBtn');
  const listUl   = document.getElementById('assetList');
  const counterP = document.getElementById('assetCounter');
  const nextBtn  = document.getElementById('nextBtn');

  function refreshUI() {
    // reconstruir lista
    listUl.innerHTML = '';
    assets.forEach(tkr => {
      const li = document.createElement('li');
      li.className = 'flex justify-between items-center bg-white border rounded px-3 py-2';
      li.innerHTML = `
        <span class="font-medium">${tkr}</span>
        <button class="text-red-600 hover:text-red-800" data-tkr="${tkr}">âœ•</button>
      `;
      listUl.appendChild(li);
    });

    // contador + botones
    counterP.textContent = `${assets.length} / ${MAX_ASSETS} activos seleccionados`;
    addBtn.disabled  = assets.length >= MAX_ASSETS;
    nextBtn.disabled = assets.length === 0;
  }

  function addAsset() {
    const tkr = inp.value.trim().toUpperCase();
    inp.value = '';

    if (!tkr) return;
    if (assets.includes(tkr)) { alert('Ya estÃ¡ en la lista'); return; }
    if (assets.length >= MAX_ASSETS) { alert('MÃ¡ximo 20 activos'); return; }

    assets.push(tkr);
    refreshUI();
  }

  function removeAsset(tkr) {
    assets = assets.filter(a => a !== tkr);
    refreshUI();
  }

  /* Listeners */
  addBtn.addEventListener('click', addAsset);
  inp.addEventListener('keydown', e => { if (e.key === 'Enter') addAsset(); });
  listUl.addEventListener('click', e => {
    if (e.target.matches('button[data-tkr]')) {
      removeAsset(e.target.dataset.tkr);
    }
  });

  /* Inicia contador */
  refreshUI();


  /* === CÃ³digo de descarga Stooq (igual al de Fase 2; aÃºn no se usa aquÃ­) === */
  async function fetchHistory(symbol) {
    const stooq = symbol.toUpperCase() + ".US";
    const url   = "https://corsproxy.io/?" +
                  encodeURIComponent(`https://stooq.com/q/d/l/?s=${stooq}&i=d`);
    const res = await fetch(url);
    if (!res.ok) throw new Error(res.status + " " + res.statusText);
    const csv = await res.text();
    const { data } = Papa.parse(csv, { header:true, dynamicTyping:true });
    return data.filter(d => d.Close);
  }
/* --- helpers de estadÃ­stica --- */
function toReturns(priceRows) {
  // usa Close y devuelve array de ln(P_t / P_{t-1})
  const r = [];
  for (let i = 1; i < priceRows.length; i++) {
    const p0 = priceRows[i-1].Close;
    const p1 = priceRows[i].Close;
    if (p0 && p1) r.push(Math.log(p1/p0));
  }
  return r;
}

function mean(arr) {
  return arr.reduce((s,v)=>s+v,0) / arr.length;
}

function covariance(x, y, mx, my) {
  let sum = 0;
  for (let i = 0; i < x.length; i++) sum += (x[i]-mx)*(y[i]-my);
  return sum / (x.length - 1);
}
/* --- utilidades de portafolios --- */
function randomWeights(n) {
  // genera n pesos positivos que suman 1
  const w = Array.from({length:n}, () => Math.random());
  const s = w.reduce((a,b)=>a+b,0);
  return w.map(x => x/s);
}

function portMean(w, mu) {
  return w.reduce((s,wi,i)=>s+wi*mu[i],0);
}

function portVar(w, Sigma) {
  let v = 0;
  for (let i=0;i<w.length;i++){
    for (let j=0;j<w.length;j++){
      v += w[i]*w[j]*Sigma[i][j];
    }
  }
  return v;
}
/* ---------- Paso 2 : descarga paralela ---------- */

nextBtn.addEventListener('click', async () => {
  statusMsg.textContent = `Descargando ${assets.length} activosâ€¦`;
  nextBtn.disabled = true;
  addBtn.disabled  = true;

  let datasets;                       // â‘  visible fuera del try

  try {
    /* ---------- Descarga paralela ---------- */
    datasets = await Promise.all(
      assets.map(tkr => fetchHistory(tkr)
        .then(rows => ({ tkr, rows }))
        .catch(err => ({ tkr, err })))
    );

    /* ---------- Resumen descargas ---------- */
    const resumen = datasets.map(d => ({
      Ticker: d.tkr,
      Filas : d.err ? 'ERROR' : d.rows.length
    }));
    console.table(resumen);

    const errores = datasets.filter(d => d.err);
    const vacios  = resumen.filter(r => r.Filas === 0);
    if (errores.length) alert('Errores en: ' + errores.map(e => e.tkr).join(', '));
    if (vacios.length)  alert('Sin datos en: ' + vacios.map(v => v.Ticker).join(', '));

    /* ---------- Paso 3: rendimientos y Î£ ---------- */
    const priceData = datasets.filter(d => !d.err && d.rows.length);
    if (priceData.length < 2) {
      console.warn('Necesitas al menos 2 activos con datos para Î£');
      return;
    }

    const returns = priceData.map(d => toReturns(d.rows));
    const minLen  = Math.min(...returns.map(r => r.length));
    const aligned = returns.map(r => r.slice(-minLen));

    const means = aligned.map(arr => mean(arr));

    const n      = aligned.length;
    const Sigma  = Array.from({ length:n }, () => Array(n).fill(0));
    for (let i = 0; i < n; i++) {
      for (let j = i; j < n; j++) {
        const cov = covariance(aligned[i], aligned[j], means[i], means[j]);
        Sigma[i][j] = Sigma[j][i] = cov;
      }
    }

    console.log('Promedios diarios (Î¼):', means);
    console.log('Matriz de covarianzas Î£:');
    console.table(Sigma.map((row, i) => ({ Ticker: priceData[i].tkr, ...row })));
/* ---------- Paso 4 : frontera eficiente ---------- */

// anualiza
const muAnn = means.map(m => m*252);
const SigmaAnn = Sigma.map(row => row.map(c => c*252));

const portfolios = [];
for (let k = 0; k < 5000; k++) {
  const w = randomWeights(muAnn.length);
  const ret = portMean(w, muAnn);
  const varP = portVar(w, SigmaAnn);
  const sd  = Math.sqrt(varP);
  portfolios.push({ w, ret, sd, sharpe: ret/sd });
}

// mÃ­nima varianza y mÃ¡ximo Sharpe
const minVar   = portfolios.reduce((a,b)=> a.sd < b.sd ? a : b);
const maxSharpe= portfolios.reduce((a,b)=> a.sharpe > b.sharpe ? a : b);

console.log('Min Var:', minVar);
console.log('Max Sharpe:', maxSharpe);

// dibuja scatter
Plotly.newPlot('chart', [
  {
    x: portfolios.map(p=>p.sd*100),
    y: portfolios.map(p=>p.ret*100),
    mode:'markers',
    marker:{ size:4, opacity:0.4 },
    name:'Portafolios'
  },
  {
    x:[minVar.sd*100], y:[minVar.ret*100],
    mode:'markers+text', text:['Min Var'],
    marker:{ size:10, color:'green' }
  },
  {
    x:[maxSharpe.sd*100], y:[maxSharpe.ret*100],
    mode:'markers+text', text:['Max Sharpe'],
    marker:{ size:10, color:'red' }
  }
], {
  title:'Frontera eficiente (anualizada)',
  xaxis:{ title:'Riesgo Ïƒ (%)' },
  yaxis:{ title:'Retorno Î¼ (%)' }
});
    
    statusMsg.textContent = 'Descarga y cÃ¡lculos completados âœ”ï¸';

  } catch (e) {
    console.error(e);
    statusMsg.textContent = 'Error general ðŸ˜“';
  } finally {
    nextBtn.disabled = false;
    addBtn.disabled  = assets.length >= MAX_ASSETS;
  }
});
  </script>
</body>
</html>
