<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Optimizer â€“ Fase 3 Â· Paso 1</title>

  <!-- CDNs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-6">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-semibold mb-6 text-center">
      Portfolio Optimizer â€“ Fase 3 Â· Paso 1
    </h1>

    <!-- === Bloque Seleccionar activos === -->
    <div class="space-y-4 mb-10">
      <!-- Campo + botÃ³n AÃ±adir -->
      <div class="flex gap-2">
        <input id="assetInput" type="text" placeholder="Ticker (ej: AAPL)"
               class="flex-1 border rounded px-3 py-2" />
        <button id="addAssetBtn"
                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          AÃ±adir
        </button>
      </div>

      <!-- Lista dinÃ¡mica -->
      <ul id="assetList" class="space-y-2"></ul>

      <!-- Contador / aviso -->
      <p id="assetCounter" class="text-sm text-gray-600"></p>

      <!-- BotÃ³n continuar (descarga en el Paso 2) -->
      <button id="nextBtn"
              class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700"
              disabled>
        Continuar con descarga â–¼
      </button>
      <p id="statusMsg" class="text-sm text-blue-600 mt-2"></p>
    </div>

    <!-- Contenedor del grÃ¡fico (lo usaremos mÃ¡s adelante) -->
    <div id="chart" class="bg-white p-4 rounded shadow-md" style="height:400px;"></div>
  </div>

  <!-- =========  SCRIPTS  ========= -->
  <script>
  console.log("ðŸ”§ Script F3-P1 cargado");

  /* ---------- GestiÃ³n de lista ---------- */
  const MAX_ASSETS = 20;
  let assets = [];                               // tickers en mayÃºsculas

  const inp      = document.getElementById('assetInput');
  const addBtn   = document.getElementById('addAssetBtn');
  const listUl   = document.getElementById('assetList');
  const counterP = document.getElementById('assetCounter');
  const nextBtn  = document.getElementById('nextBtn');

  function refreshUI() {
    // reconstruir lista
    listUl.innerHTML = '';
    assets.forEach(tkr => {
      const li = document.createElement('li');
      li.className = 'flex justify-between items-center bg-white border rounded px-3 py-2';
      li.innerHTML = `
        <span class="font-medium">${tkr}</span>
        <button class="text-red-600 hover:text-red-800" data-tkr="${tkr}">âœ•</button>
      `;
      listUl.appendChild(li);
    });

    // contador + botones
    counterP.textContent = `${assets.length} / ${MAX_ASSETS} activos seleccionados`;
    addBtn.disabled  = assets.length >= MAX_ASSETS;
    nextBtn.disabled = assets.length === 0;
  }

  function addAsset() {
    const tkr = inp.value.trim().toUpperCase();
    inp.value = '';

    if (!tkr) return;
    if (assets.includes(tkr)) { alert('Ya estÃ¡ en la lista'); return; }
    if (assets.length >= MAX_ASSETS) { alert('MÃ¡ximo 20 activos'); return; }

    assets.push(tkr);
    refreshUI();
  }

  function removeAsset(tkr) {
    assets = assets.filter(a => a !== tkr);
    refreshUI();
  }

  /* Listeners */
  addBtn.addEventListener('click', addAsset);
  inp.addEventListener('keydown', e => { if (e.key === 'Enter') addAsset(); });
  listUl.addEventListener('click', e => {
    if (e.target.matches('button[data-tkr]')) {
      removeAsset(e.target.dataset.tkr);
    }
  });

  /* Inicia contador */
  refreshUI();


  /* === CÃ³digo de descarga Stooq (igual al de Fase 2; aÃºn no se usa aquÃ­) === */
  async function fetchHistory(symbol) {
    const stooq = symbol.toUpperCase() + ".US";
    const url   = "https://corsproxy.io/?" +
                  encodeURIComponent(`https://stooq.com/q/d/l/?s=${stooq}&i=d`);
    const res = await fetch(url);
    if (!res.ok) throw new Error(res.status + " " + res.statusText);
    const csv = await res.text();
    const { data } = Papa.parse(csv, { header:true, dynamicTyping:true });
    return data.filter(d => d.Close);
  }

/* ---------- Paso 2 : descarga paralela ---------- */

nextBtn.addEventListener('click', async () => {
  statusMsg.textContent = `Descargando ${assets.length} activosâ€¦`;
  nextBtn.disabled = true;      // evita doble clic
  addBtn.disabled  = true;

  try {
    // descarga todos los CSV a la vez
    const datasets = await Promise.all(
      assets.map(tkr => fetchHistory(tkr)
        .then(rows => ({ tkr, rows }))
        .catch(err => ({ tkr, err })))
    );

    // comprueba resultados y muestra un mini-resumen
    console.table(datasets.map(d => ({
      Ticker: d.tkr,
      Filas : d.err ? 'ERROR' : d.rows.length
    })));

    const errores = datasets.filter(d => d.err);
    if (errores.length) {
      alert('Hubo errores con: ' + errores.map(e => e.tkr).join(', '));
    } else {
      alert('Descarga completa âœ”ï¸');
    }

    statusMsg.textContent = 'Descarga terminada.';
  } catch (e) {
    console.error(e);
    statusMsg.textContent = 'Error general ðŸ˜“';
  } finally {
    nextBtn.disabled = false;
    addBtn.disabled  = assets.length >= MAX_ASSETS;
  }
});
  </script>
</body>
</html>
