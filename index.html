<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Optimizador de Portafolio Pro</title>

  <!-- Tus fuentes + estilos originales ------------------------------->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
 

  <!-- Librerías externas (CDN) --------------------------------------->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <!-- ============  TU PLANTILLA ORIGINAL  ============ -->
  <!-- (solo se añadieron id que faltaban y se quitó el botón duplicado) -->

  <header><h1>Optimizador de Portafolio Pro</h1></header>

  <div class="container">
    <aside class="sidebar">
      <div class="control-group">
        <label for="asset-search">Buscar y Seleccionar Activos</label>
        <!-- ① input que usará el script -->
        <input type="text" id="asset-search" placeholder="Ticker o Nombre: Ej: AAPL, MSFT…">
        <!-- ② botón añadir -->
        <button id="addAssetBtn" class="button secondary" style="margin-top:10px; width:100%;">Añadir Activo</button>
      </div>
<!-- Frecuencia de datos -->
<div class="control-group">
  <label for="freq-select">Frecuencia de datos:</label>
  <select id="freq-select">
    <option value="d" selected>Diaria</option>
    <option value="w">Semanal</option>
    <option value="m">Mensual</option>
  </select>
</div>
      <div class="control-group">
  <label>Desde:</label>
  <input type="date" id="from-date">
</div>
<div class="control-group">
  <label>Hasta:</label>
  <input type="date" id="to-date">
</div>
      <!-- ③ lista dinámica -->
      <div class="control-group">
        <label>Activos Seleccionados:</label>
        <ul class="selected-assets-list" id="assetList"></ul>
        <p id="assetCounter" class="text-sm" style="margin:4px 0;"></p>
      </div>
      
<!-- Tasa libre de riesgo -->
<div class="control-group">
  <label for="rf-input">Tasa libre de riesgo&nbsp;(anual&nbsp;%):</label>
  <input type="number"
         id="rf-input"
         value="2"
         min="0"
         step="0.25">
</div>

      <!-- ▌ NUEVO : monto a invertir + selector de riesgo ---------------->
<div class="control-group">
  <label for="investment-amount">Monto a Invertir (USD):</label>
  <input type="number" id="investment-amount" value="10000"
         min="0" step="100">
</div>

<div class="slider-container control-group">
  <label for="risk-tolerance">
        Preferencia Riesgo / Retorno
  </label>
  <input type="range" id="risk-tolerance" min="0" max="100" value="50">
  <div class="slider-labels">
    <span>Conservador</span><span>Agresivo</span>
  </div>
</div>
<!-- ▌ fin bloque nuevo ---------------------------------------------->


      <!-- ④ botón principal -->
      <button id="optimizeBtn" class="button success" style="width:100%;">Optimizar Portafolio</button>
    </aside>

    <main class="main-content">
      <h2 class="section-title">Frontera Eficiente &amp; Composición</h2>

      <!-- ⑤ aquí cae el gráfico -->
      <div class="chart-placeholder" id="efficient-frontier-chart">
        Gráfico en preparación…
      </div>

      <div class="portfolio-details">
        <h3 class="section-title">Portafolio Máx Sharpe</h3>
        <div class="risk-return-display">
          <p><strong>Retorno&nbsp;μ (anual):</strong> <span id="portfolio-return">–</span></p>
          <p><strong>Riesgo&nbsp;σ (anual):</strong> <span id="portfolio-risk">–</span></p>
        </div>
        <h4 id="total-investment-display">Distribución óptima de activos:</h4>
        <ul class="weights-list" id="portfolio-weights"></ul>
      </div>
    </main>
  </div>

  <footer>© 2025 Optimizador de Portafolio Pro – solo fines educativos</footer>

  <!-- ===================  SCRIPT  ==================== -->
<script>
/* ===== 1. Config & helpers ======================================== */
const MAX_ASSETS   = 20;
const listUl       = document.getElementById('assetList');
const counterP     = document.getElementById('assetCounter');
const addBtn       = document.getElementById('addAssetBtn');
const inp          = document.getElementById('asset-search');
const optimizeBtn  = document.getElementById('optimizeBtn');
const amountInput  = document.getElementById('investment-amount');
const riskRange    = document.getElementById('risk-tolerance');
let   assets       = [];                 // tickers en mayúsculas

function refreshUI () {
  listUl.innerHTML = '';
  assets.forEach(t => {
    const li = document.createElement('li');
    li.innerHTML = `<span>${t}</span><button data-tkr="${t}">✕</button>`;
    listUl.appendChild(li);
  });
  counterP.textContent = `${assets.length} / ${MAX_ASSETS} activos`;
  addBtn.disabled      = assets.length >= MAX_ASSETS;
  optimizeBtn.disabled = assets.length < 2;
}
function addAsset () {
  const t = inp.value.trim().toUpperCase();
  inp.value = '';
  if (!t || assets.includes(t) || assets.length >= MAX_ASSETS) return;
  assets.push(t);
  refreshUI();
}
listUl.addEventListener('click', e => {
  if (e.target.dataset.tkr) {
    assets = assets.filter(x => x !== e.target.dataset.tkr);
    refreshUI();
  }
});
addBtn.addEventListener('click', addAsset);
inp.addEventListener('keydown', e => { if (e.key === 'Enter') addAsset(); });
refreshUI();

/* ===== 2. Fetch histórico Stooq + filtrado por fecha ============== */
async function fetchHistory (tkr) {
  const freq = document.getElementById('freq-select').value;  // d / w / m
  const url  = 'https://corsproxy.io/?' +
               encodeURIComponent(`https://stooq.com/q/d/l/?s=${tkr}.US&i=${freq}`);
  const csv  = await fetch(url).then(r => r.text());
  const { data } = Papa.parse(csv, { header: true, dynamicTyping: true });

  const from = document.getElementById('from-date').value;
  const to   = document.getElementById('to-date').value;

  return data.filter(r => {
    if (!r.Date || !r.Close) return false;
    if (from && r.Date < from) return false;
    if (to   && r.Date > to)   return false;
    return true;
  });
}
function toReturns (rows) {
  const r = [];
  for (let i = 1; i < rows.length; i++) {
    const p0 = rows[i-1].Close, p1 = rows[i].Close;
    if (p0 && p1) r.push(Math.log(p1/p0));
  }
  return r;
}
/* helpers estadísticos */
const mean = a => a.reduce((s,v) => s+v,0) / a.length;
const cov  = (x,y,mx,my) => x.reduce((s,v,i)=>s+(v-mx)*(y[i]-my),0)/(x.length-1);
const randW= n => { const w = Array.from({length:n},Math.random);
                    const s = w.reduce((a,b)=>a+b,0); return w.map(v=>v/s); };
const pMean= (w,mu)=>w.reduce((s,wi,i)=>s+wi*mu[i],0);
const pVar = (w,S)=>w.reduce((s,wi,i)=>s+wi*
                   w.reduce((ss,wj,j)=>ss+wj*S[i][j],0),0);

/* ===== 3. Botón Optimizar ========================================= */
optimizeBtn.addEventListener('click', async () => {
  optimizeBtn.disabled = true;
  try {
    /* 3.1 descarga paralela */
    const sets = await Promise.all(assets.map(t => fetchHistory(t)));

    /* 3.2 alineación */
    const rets  = sets.map(toReturns);
    const minL  = Math.min(...rets.map(r => r.length));
    const aligned = rets.map(r => r.slice(-minL));

    /* 3.3 µ y Σ (anualizados según frecuencia) */
    const freq  = document.getElementById('freq-select').value;
    const ann   = { d:252, w:52, m:12 }[freq] || 252;

    const mu = aligned.map(mean).map(m => m * ann);
    const Σ  = aligned.map((r,i)=>aligned.map((c,j)=>
                 cov(r,c, mu[i]/ann, mu[j]/ann) * ann));

    /* 3.4 simulación Monte-Carlo */
    const rf = parseFloat(document.getElementById('rf-input').value)/100;
    const sims = [];
    for (let k = 0; k < 5000; k++) {
      const w  = randW(mu.length);
      const r  = pMean(w, mu);
      const sd = Math.sqrt(pVar(w, Σ));
      sims.push({ w, r, sd, sh: (r - rf) / sd });
    }
    const minV   = sims.reduce((a,b)=>a.sd < b.sd ? a : b);
    const maxS   = sims.reduce((a,b)=>a.sh > b.sh ? a : b);
    const alpha  = riskRange.value / 100;
    const wStar  = minV.w.map((w,i)=>w*(1-alpha)+maxS.w[i]*alpha);
    const rStar  = pMean(wStar, mu);
    const sdStar = Math.sqrt(pVar(wStar, Σ));

    /* 3.5 gráfico */
    document.getElementById('efficient-frontier-chart').innerHTML = '';
    Plotly.newPlot('efficient-frontier-chart', [
      { x:sims.map(p=>p.sd*100), y:sims.map(p=>p.r*100),
        mode:'markers', marker:{size:4,opacity:.4}, name:'Portafolios' },
      { x:[minV.sd*100], y:[minV.r*100], mode:'markers+text',
        text:['Min Var'], marker:{color:'green',size:10} },
      { x:[maxS.sd*100], y:[maxS.r*100], mode:'markers+text',
        text:['Máx Sharpe'], marker:{color:'red',size:10} },
      { x:[sdStar*100], y:[rStar*100], mode:'markers+text',
        text:['Tu elección'], marker:{color:'gold',size:12,symbol:'star'} }
    ], {
      title:'Frontera eficiente (anualizada)',
      xaxis:{ title:'Riesgo σ (%)' },
      yaxis:{ title:'Retorno μ (%)' }
    });

    /* 3.6 métricas */
    document.getElementById('portfolio-return').textContent =
        (rStar*100).toFixed(2)+' %';
    document.getElementById('portfolio-risk').textContent  =
        (sdStar*100).toFixed(2)+' %';

    /* 3.7 lista de pesos */
    const total = parseFloat(amountInput.value) || 0;
    document.getElementById('total-investment-display').textContent =
      `Distribución óptima de activos (${total.toLocaleString('en-US',
        {style:'currency',currency:'USD',minimumFractionDigits:0})} invertidos):`;

    const ul = document.getElementById('portfolio-weights');
    ul.innerHTML = '';
    wStar.forEach((w,i) => {
      const usd = w * total;
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="asset-name">${assets[i]}</span><span></span>
        <span class="asset-weight">${(w*100).toFixed(2)} %</span>
        <span class="asset-amount">${usd.toLocaleString('en-US',
          {style:'currency',currency:'USD',minimumFractionDigits:0})}</span>`;
      ul.appendChild(li);
    });

    console.log('µ:',mu,'Σ:',Σ,'Tu portfolio:',wStar);
  } catch (err) {
    alert(err.message);
    console.error(err);
  } finally {
    optimizeBtn.disabled = false;
  }
});
</script>
</body>
</html>
